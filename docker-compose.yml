version: '3.8'

services:
  # MongoDB (Auto-Acct Backend)
  mongodb:
    image: mongo:7-jammy
    container_name: auto_acct_mongo
    ports:
      - "27017:27017"
    command: [ "--replSet", "rs0", "--bind_ip_all", "--port", "27017" ]
    volumes:
      - mongo_data:/data/db
      - ./docker/mongodb/init-replica.sh:/docker-entrypoint-initdb.d/init-replica.sh
    environment:
      - MONGO_REPLICA_SET_NAME=rs0
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - auto-acct-network

  # PostgreSQL (Teable)
  teable-db:
    image: postgres:15-alpine
    container_name: teable-postgres
    restart: always
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: teable
      POSTGRES_PASSWORD: teable_password
      POSTGRES_DB: teable
    volumes:
      - teable_db:/var/lib/postgresql/data
    networks:
      - auto-acct-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U teable" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Teable App
  teable:
    image: ghcr.io/teableio/teable:latest
    container_name: auto_acct_teable
    restart: always
    # entrypoint: ["/bin/sh", "-c", "tail -f /dev/null"] # Override entrypoint to keep it running
    # command: [ "tail", "-f", "/dev/null" ]
    ports:
      - "3000:3000"
    depends_on:
      teable-db:
        condition: service_healthy
    environment:
      # Connection to Postgres
      DATABASE_URL: "postgresql://teable:teable_password@teable-db:5432/teable"
      PRISMA_DATABASE_URL: "postgresql://teable:teable_password@teable-db:5432/teable"
      NODE_ENV: production
      PUBLIC_ORIGIN: http://localhost:3000
      # Secrets from .env
      SECRET_KEY: ${TEABLE_SECRET_KEY}
      SESSION_SECRET: ${TEABLE_SESSION_SECRET}
    networks:
      - auto-acct-network
    volumes:
      - teable_data:/app/.teable
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # PaddleOCR Worker (Phase 3B)
  # Critical Modification #3: Auto-restart policy + resource management
  ocr-worker:
    build:
      context: ./ocr-worker
      dockerfile: Dockerfile
    container_name: auto_acct_ocr
    restart: unless-stopped # Critical #3: Auto-restart on failure
    ports:
      - "5000:5000"
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - auto-acct-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s # Allow time for model loading
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1.5G
    depends_on:
      mongodb:
        condition: service_healthy

networks:
  auto-acct-network:
    driver: bridge

volumes:
  mongo_data:
  teable_db:
  teable_data:


